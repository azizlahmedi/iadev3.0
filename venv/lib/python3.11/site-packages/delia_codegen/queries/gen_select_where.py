from delia_parser import ast
from delia_codegen.utils import adl_name_to_py_name


class SelectWhere:

    def select_where(self, node):

        relation = node.relation_name
        relation_python_name = adl_name_to_py_name(relation)
        qualified_rel_alias = node.qualified_rel_alias
        py_scope = adl_name_to_py_name(node.scope)

        is_where_optimized = qualified_rel_alias.is_where_optimized
        if not is_where_optimized:
            where_clause = qualified_rel_alias.where_clause
        else:
            where_clause = None

        sort_list = qualified_rel_alias.sort_list

        via_expressions = qualified_rel_alias.via_expressions
        via_values = qualified_rel_alias.via_values

        then_stmts = node.then_else_clause.then_stmts
        else_stmts = node.then_else_clause.else_stmts

        for_update = node.got_alter

        sorted_fields = self.build_sort_list(sort_list)
        if via_expressions:
            where_sql = str(via_expressions)
        else:
            where_sql = None

        fetched = []
        for col in relation.definition.columns:
            if col in node.scope.fetched_columns:
                fetched.append(col)

        fetched_python_name = ["'%s'" % adl_name_to_py_name(fetch) for fetch in fetched]
        where_routine_params = [adl_name_to_py_name(field) for field in node.scope.where_routine_params]

        query_id = self.collector.append_foreach(
            relation=relation_python_name,
            fields=fetched_python_name,
            expr=[],
            group=[],
            sort=sorted_fields,
            where=where_sql,
            for_update=for_update)

        self.src.newline("for %s in _foreach('%s').fetchMany(" % (py_scope, query_id))

        if where_sql:
            self.render_via_values(via_values)

        if where_clause:
            self.src.write("where_routine=lambda %s: " % ', '.join(where_routine_params))
            self.visit(where_clause)

        self.src.write("):")

        self.src.indent()

        self.src.indent()
        self.visit(then_stmts)
        self.src.newline("break", no_locations=True)
        self.src.dedent()

        self.src.dedent()

        if else_stmts and not (len(else_stmts) == 1 and isinstance(else_stmts[0], ast.Nothing)):
            self.src.newline("else:")
            self.src.indent()
            self.visit(else_stmts)
            self.src.dedent()
