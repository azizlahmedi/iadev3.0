from delia_codegen.utils import adl_name_to_py_name
from delia_codegen.convert_type import convert_type


class ImplicitSelect:

    @convert_type
    def gen_ImplicitSelect(self, node):

        relation = node.relation_name
        relation_python_name = adl_name_to_py_name(relation)
        field_name = node.field_name

        qualified_rel_alias = node.qualified_rel_alias

        via_values = qualified_rel_alias.via_values

        query_id = self.collector.append_select_viakey(
            relation=relation_python_name,
            fields=["'%s'" % adl_name_to_py_name(field_name)],
            for_update=False)

        self.src.write("_select_viakey('%s').fetchOneField(" % query_id)
        self.src.write("%s, " % self.get_default_value(field_name))
        self.render_via_values(via_values)
        self.src.write(")")
