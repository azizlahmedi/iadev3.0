# -*- coding:utf-8 -*-

from delia_commons.errors import ErrorCode
from delia_parser.ast import Relation


class Insert:
    def visit_Insert(self, node):

        self.visit(node.relation_name)

        relation_definition = node.relation_name.definition
        if not relation_definition:
            self.add_error(ErrorCode.NAME_UNDECLARED_USAGE, node.relation_name, name=node.relation_name)
        elif not isinstance(relation_definition, Relation):
            self.add_error(ErrorCode.INVALID_DEFINITION_TYPE, node.relation_name, name=node.relation_name, kind="RELATION")

        if not node.is_relation_declared:
            return

        self.visit(node.duplicate_clause)
        self.visit(node.using_clauses)

        if node.using_clauses:
            for using_clause in node.using_clauses:
                if relation_definition and using_clause.parametre not in relation_definition.columns:
                        self.add_error(ErrorCode.FIELD_WRONG_USAGE, using_clause,
                                       name=using_clause.parametre, relation_name=relation_definition.name)
