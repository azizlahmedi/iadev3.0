# -*- coding: utf-8 -*-
import os
import tempfile
import unittest
import uuid
from unittest import TestCase

import factory_tests
from factory.backends.artifact import ArtifactBackend


class ArtifactBackendTestCase(TestCase):
    def test(self):
        backend = ArtifactBackend(factory_tests.ARTIFACTORY_USER, factory_tests.ARTIFACTORY_PASSWD)
        url = factory_tests.ARTIFACTORY_SRC_URL + '/test/%s.dat' % str(uuid.uuid4())
        with tempfile.TemporaryDirectory() as temp:
            path = os.path.join(temp, 'test.dat')
            content = 'toto'
            with open(path, 'w', encoding='utf-8') as fd:
                fd.write(content)
            self.assertFalse(backend.exists(url))
            backend.put(url, path, {'hello': 'world'})
            self.assertTrue(backend.exists(url))
            backend.get(url, path)
            with open(path, 'r', encoding='utf-8') as fd:
                self.assertEqual(content, fd.read())
            content = 'tutu'
            with open(path, 'w', encoding='utf-8') as fd:
                fd.write(content)
            backend.put(url, path)
            backend.get(url, path)
            with open(path, 'r', encoding='utf-8') as fd:
                self.assertEqual(content, fd.read())


if __name__ == '__main__':
    unittest.main()
