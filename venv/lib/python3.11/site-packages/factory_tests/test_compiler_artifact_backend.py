# -*- coding: utf-8 -*-
import os
import subprocess
import tempfile
import unittest
from unittest import TestCase

import factory_tests
from factory.backends.artifact import CompilerArtifactBackend


class CompilerArtifactBackendTestCase(TestCase):
    def test_artifact_url(self):
        backend = CompilerArtifactBackend('http://toto/', 'john', 'doe')
        url = backend.artifact_url('1.0')
        self.assertEqual('http://toto/deliac-env/1.0/deliac-env-1.0-linux-x86_64.tar.gz', url)

    def test(self):
        backend = CompilerArtifactBackend(factory_tests.ARTIFACTORY_COMPILER_URL, factory_tests.ARTIFACTORY_USER,
                                          factory_tests.ARTIFACTORY_PASSWD)
        with tempfile.TemporaryDirectory() as temp:
            support_home = os.path.join(temp, 'env')
            backend.extract('0.0.3', support_home)
            command = [os.path.join(support_home, 'bin', 'python3'), '-c', 'print("hello")']
            output = subprocess.check_output(command).decode('utf-8')
            self.assertEqual('hello\n', output)


if __name__ == '__main__':
    unittest.main()
